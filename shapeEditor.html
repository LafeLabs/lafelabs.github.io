<!DOCTYPE html>
<html>
<head>
<title>Geometron Tree</title>
<script src="libraries/geometronLibrary3.js">
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
initGeometron();
loadTable();
currentAddress = 0210;
</script>
</head>
<body>
<div id = "main">

</div>
<script>

canvasOrText = true;

glyphButtonSize = 40;
currentNode = document.getElementById("main");

controlPanel = document.createElement("span");
controlPanel.className = "controlPanel";

rootPanel = document.createElement("span");
rootPanel.className = "rootPanel";


drawCanvas = document.createElement("canvas");
drawCanvas.width = 600;
drawCanvas.height = 400;
drawCanvas.id = "drawCanvas";
ctx = drawCanvas.getContext("2d");
ctx.fillStyle="white";
ctx.fillRect(0, 0, 600,400);
ctx.fillStyle="black";

spellCanvas = document.createElement("canvas");
spellCanvas.width = 300;
spellCanvas.height = 260;
spellCanvas.id = "spellCanvas";

ctx = spellCanvas.getContext("2d");
ctx.fillStyle="white";
ctx.fillRect(0, 0, 300,400);
ctx.fillStyle="black";

mainTextArea = document.createElement("textarea");
mainTextArea.id = "mainTextArea";
mainTextArea.value = byteCode2string(currentTable[0330]);


currentNode.appendChild(drawCanvas);//main

//currentNode.replaceChild(mainTextArea,drawCanvas);//mozilla docs are flat out bullshit here
//currentNode.replaceChild(drawCanvas,mainTextArea);

addressInput = document.createElement("input");
addressInput.id = "addressInput";
nameInput = document.createElement("input");
nameInput.id = "nameInput";

bytecode = document.createElement("input");
bytecode.id = "bytecode";
bytecode.size = 42;

currentNode.appendChild(mainTextArea);
currentNode.appendChild(spellCanvas);
currentNode.appendChild(addressInput);
currentNode.appendChild(nameInput);
currentNode.appendChild(bytecode);
currentNode.appendChild(rootPanel);
currentNode.appendChild(controlPanel);

currentNode = controlPanel;
appendScalePanel();
appendMovementPanel();
commandArray1 = [0340,0341,0342,0343,0344,0345,0346,0347,0200,0365,0366,0201];
commandArray2 = [0210,0211,0212,0224,0214,0215,0216,0217,0220,0221,0222,0223];
commandArray3 = [020,021,022,023,010,024,025,026,027];

appendDrawPanel(commandArray1);
appendDrawPanel(commandArray2);

currentNode = rootPanel;
appendDrawPanel(commandArray3);


currentAddress = 0210;
currentGlyph = currentTable[currentAddress];
currentGlyphArray = currentGlyph.split(",");
cursorPosition = currentGlyphArray.length;

addressInput.value = "0" + currentAddress.toString(8);

bytecode.value = currentGlyph;

redraw();


function redraw(){

	currentGlyphArray = currentGlyph.split(",");
	firstHalf = "";
	secondHalf = "";	
	for(var index = 0;index < cursorPosition;index++){
		firstHalf += currentGlyphArray[index] + ",";
	}
	for(var index = cursorPosition;index < currentGlyphArray.length;index++){
		secondHalf += currentGlyphArray[index] + ",";
	}


	ctx = document.getElementById("drawCanvas").getContext("2d");	
	ctx.clearRect(0, 0, 600, 400);
	doTheThing(0300);	
	drawGlyph(firstHalf);	drawGlyph("0342,0334,0342,0335,0335,0342,0334,0337,0330,0340,0331,0336,0336,0330,0340,0331,0337");//cursor
	drawGlyph(secondHalf);	

	var tempSide = side;
	ctx = document.getElementById("spellCanvas").getContext("2d");		
	ctx.clearRect(0, 0, 300, 260);
	doTheThing(0300);			
	x = 10;
	y = 25;
	side = 20;

	firstHalfArray = firstHalf.split(",");
	for(var index = 0;index < firstHalfArray.length;index++){
		doTheThing(01000 + parseInt(firstHalfArray[index],8));
		if(x > 274){
			x = 10;
			y += 22;
		}	
		if(y > 500){
			break;
		}
	}
drawGlyph("0333,0336,0330,0332,0336,0336,0341,0337,0342,0335,0335,0342,0340,0335,0335,0335,0334,0331,0331,0333,0333,0337,0337");

	secondHalfArray = secondHalf.split(",");
	for(var index = 0;index < secondHalfArray.length;index++){
		doTheThing(01000 + parseInt(secondHalfArray[index],8));
		if(x > 270){
			x = 10;
			y += 32;
		}	
		if(y > 500){
			break;
		}

	}

	side = tempSide;	
	currentTable[currentAddress] = currentGlyph;
	addressInput.value = "0" + currentAddress.toString(8);
	bytecode.value = currentGlyph;

}


function glyphButtonAction(localCommand){
		
	console.log(localCommand);

	if(localCommand < 040){
		localRoot(localCommand);
	}
	if(localCommand >= 040 ){
		
		firstHalf += "0" + localCommand.toString(8) + ",";
		currentGlyph = firstHalf + secondHalf;
		cursorPosition++;	
		redraw();
	}
}

function appendDrawPanel(commandArray){
	
	var newDiv = document.createElement("DIV");	
	newDiv.className = "drawPad";
//	var commandArray = [0340,0341,0342,0343,0344,0345,0346,0347,0200,0365,0366,0201];
	var tempNode = currentNode;
	currentNode = newDiv;
	for(var index = 0;index < commandArray.length;index++){
		appendGlyphButton(commandArray[index]);	
	}	
	currentNode = tempNode;
	currentNode.appendChild(newDiv);
}


function appendMovementPanel(){
	
	var newDiv = document.createElement("DIV");	
	newDiv.className = "movePad";
	var commandArray = [0334,0330,0335,0332,0300,0333,0336,0331,0337];
	var tempNode = currentNode;
	currentNode = newDiv;
	for(var index = 0;index < commandArray.length;index++){
		appendGlyphButton(commandArray[index]);	
	}	
	currentNode = tempNode;
	currentNode.appendChild(newDiv);
}


function appendScalePanel(){
	
	var newDiv = document.createElement("DIV");	
	newDiv.className = "scalePad";
	var commandArray = [0304,0305,0306,0314,0310,0311,0312,0313,0350,0351,0352,0353];
	var tempNode = currentNode;
	currentNode = newDiv;
	for(var index = 0;index < commandArray.length;index++){
		appendGlyphButton(commandArray[index]);	
	}	
	currentNode = tempNode;
	currentNode.appendChild(newDiv);
	
}


function appendGlyphButton(localCommand){
	
	var newCanvas = document.createElement("CANVAS");		
	newCanvas.width = glyphButtonSize;
	newCanvas.height = glyphButtonSize;
	newCanvas.className = "glyphButtons";
	ctx = newCanvas.getContext("2d");
	ctx.fillStyle="white";
	ctx.fillRect(5, 5, glyphButtonSize-10, glyphButtonSize-10);
	ctx.fillStyle="black";
	doTheThing(0300);			
	x = 5;
	y = glyphButtonSize-5;
	side = glyphButtonSize-10;
	doTheThing(localCommand + 01000);
	newCanvas.onclick = function(){
		glyphButtonAction("0" + localCommand.toString(8));							
	}
	
	currentNode.appendChild(newCanvas);

}


function localRoot(localCommand){
	console.log( parseInt(localCommand,8).toString(8) );
	localCommand = parseInt(localCommand,8);
	if(localCommand == 010){
		console.log("foo");
			currentGlyphArray = currentGlyph.split(",");
			firstHalf = "";
			secondHalf = "";	
			for(var index = 0;index < cursorPosition - 1;index++){
				firstHalf += currentGlyphArray[index] + ",";
			}
			for(var index = cursorPosition;index < currentGlyphArray.length+1;index++){
				secondHalf += currentGlyphArray[index] + ",";
			}		
			
			currentGlyph = firstHalf + secondHalf;
		cursorPosition--;
		redraw();
		console.log(cursorPosition);
	}
	

	if(localCommand == 0020){
		cursorPosition--;
		if(cursorPosition < 0){
			cursorPosition = currentGlyphArray.length;			
		}
		redraw();
	}
	if(localCommand == 0021){
		cursorPosition++;
		if(cursorPosition > currentGlyphArray.length ){
			cursorPosition = 0;
		}
		redraw();
	}	
	if(localCommand == 0022){
		currentAddress--;
		currentGlyph = currentTable[currentAddress];
		currentGlyphArray = currentGlyph.split(",");
		cursorPosition = currentGlyphArray.length;
		redraw();
	}
	if(localCommand == 0023){
		currentAddress++;
		currentGlyph = currentTable[currentAddress];
		currentGlyphArray = currentGlyph.split(",");
		cursorPosition = currentGlyphArray.length;
		redraw();

	}	
	if(localCommand == 0024){
		if(currentAddress < 01000 && currentAddress > 0){
			currentAddress += 01000;
			currentGlyph = currentTable[currentAddress];

		}
		currentGlyphArray = currentGlyph.split(",");
		cursorPosition = currentGlyphArray.length;
		redraw();

	}	
	if(localCommand == 0025){
		if(currentAddress > 01000 && currentAddress < 02000){
			currentAddress -= 01000;
			currentGlyph = currentTable[currentAddress];
		}
		currentGlyphArray = currentGlyph.split(",");
		cursorPosition = currentGlyphArray.length;
		redraw();
	}
	
	if(localCommand == 0026){//switch to text
		currentNode = document.getElementById("main");
  	    currentNode.replaceChild(mainTextArea,drawCanvas);// 	
	}
	if(localCommand == 0027){//switch to canvas
		currentNode = document.getElementById("main"); 	    
  	    currentNode.replaceChild(drawCanvas,mainTextArea);
	}


}



</script>
<style id = "mainStyle">
html {
	height: 100%;
	background: black;
	background-size: cover;
}

#main{
	width: 1000px;
	height: 600px;
    border-style: solid;
    border-width: 10px;
    border-color: white;
    border-radius: 20px;
    margin: 5px 5px 5px 5px;
	padding: 5px 5px 5px 5px;
	background: black;	
}

#mainTextArea{
	
	width: 300px;
	height: 80px;
	border-color: white;
    border-width: 0px;
    border-style: solid;
	background: white;
    border-radius: 5px;
    margin: 10px 10px 10px 10px;
    float: left;

}

#drawCanvas{
	border-color: white;
    border-width: 0px;
    border-style: solid;
	background: white;
    border-radius: 5px;
    margin: 10px 5px 5px 55px;
        float: left;


}

#spellCanvas{
	border-color: white;
    border-width: 0px;
    border-style: solid;
	background: white;
    border-radius: 5px;
    float: left;
    margin: 10px 10px 10px 10px;

}

.controlPanel{
	width: 670px;
	height: 140px;
	background: black;
	border-color: green;
    border-width: 5px;
    border-style: solid;
	padding: 5px 5px 5px 5px;
	margin: 10px 10px 10px 10px;
	border-radius: 10px;
	float:left;
}
.rootPanel{
	width: 250px;
	height: 140px;
	background: black;
	border-color: purple;
    border-width: 5px;
    border-style: solid;
	padding: 5px 5px 5px 5px;
	margin: 10px 10px 10px 10px;
	border-radius: 10px;
	float:right;
}



.movePad{
    border-style: solid;
	width: 120px;
	height: 120px;
	background: white;	
	margin: 5px 5px 5px 5px;
	float:left;
}

.scalePad{
    border-style: solid;
	width: 160px;
	height: 120px;
	background: white;	
	margin: 5px 5px 5px 5px;
	float:left;
}

.drawPad{
    border-style: solid;
	width: 160px;
	height: 120px;
	background: white;	
	margin: 5px 5px 5px 5px;
	float:left;
}

.glyphButtons{
    border-style: solid;
    border-width: 0px;
    border-color: black;
    background: white;	
}
.glyphButtons:hover{
    background: gray;	

}
.glyphButtons:active{
    background: yellow;	
}


</style>
</body>
</html>

